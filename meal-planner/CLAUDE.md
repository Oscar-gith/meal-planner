# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Meal planner application with 2-level architecture: Ingredients → Meal Patterns → Weekly Plans. Built with Next.js 15, React 19, TypeScript, and Supabase (PostgreSQL + Auth). Features family sharing system similar to Duolingo Family.

**Context:** This is a learning project. The developer is actively learning modern web development practices, which means the codebase may not always follow the most orthodox approaches. When suggesting improvements, prioritize clear explanations and educational value over strict adherence to best practices. Be patient and explain the "why" behind recommendations.

## Common Commands

### Development
```bash
npm run dev              # Start dev server (uses .env.local = dev project)
npm run build            # Production build
npm start                # Production server
npm run lint             # Run ESLint
```

**IMPORTANT:** `npm run dev` now uses the development Supabase project (vxhjzhwlyuiinpelpqae), which is safe for experimentation. See [docs/AMBIENTES.md](docs/AMBIENTES.md) for full environment configuration.

### Testing
```bash
npm test                 # Vitest in watch mode
npm run test:ui          # Vitest UI dashboard
npm run test:coverage    # Coverage report (threshold: 70%)
npm run test:e2e         # Playwright E2E tests
npm run test:e2e:ui      # Playwright UI mode
npm run test:e2e:debug   # Playwright debug mode
```

**Important:** Testing uses separate Supabase project (xgofutvrhfpywqhrrvlp) configured in `tests/.env.test`.

## Architecture

### Data Model (2 Levels)

```
Level 1: Ingredients (food_ingredients table)
  ↓
Level 2: Meal Patterns (meal_patterns table)
  - 7 predefined patterns: Desayuno (2), Almuerzo (3), Onces (2)
  - Each pattern defines required ingredient types
  ↓
Weekly Plans (weekly_plans table)
  - Generated by WeeklyPlanningEngine
  - Combines patterns with available ingredients
```

### Core Tables

- `food_ingredients` - Individual ingredients with types (Proteína, Carb, Ensalada, Fruta, etc.)
- `meal_patterns` - 7 predefined meal patterns stored in DB
- `weekly_plans` - Generated weekly meal plans
- `pattern_distributions` - Pattern occurrence configuration per meal type
- `families` - Family groups for sharing
- `family_members` - Family membership (admin/member roles)
- `user_profiles` - User display names
- `rules` - User-defined meal planning rules (AI-powered validation)
- `agent_logs` - LangGraph agent execution logs for debugging

**All tables use RLS** (Row Level Security) filtering by `family_id`. Data is shared within families.

**Database Schema:** The complete schema is defined in [supabase/migrations/000_initial_schema.sql](supabase/migrations/000_initial_schema.sql)

### Weekly Planning Engine

Location: [src/lib/weekly-planner.ts](src/lib/weekly-planner.ts)

The `WeeklyPlanningEngine` class generates meal plans based on:
- Available ingredients grouped by type
- Pattern availability validation ([src/lib/meal-patterns.ts](src/lib/meal-patterns.ts))
- Pattern distributions (how many times each pattern should appear)
- Rules to avoid ingredient repetition

Key method: `generatePlan()` returns a `PlanningResult` with plan, warnings, and stats.

### Authentication & Family System

- Supabase Auth with email/password + Google OAuth
- Middleware protection in [src/middleware.ts](src/middleware.ts)
- Family sharing: Users join families via invite codes
- Family data access handled by RLS policies using `get_current_user_family_id()` helper function

**Critical:** The family system replaced the deprecated `plan_collaborators` table. All data sharing now goes through families.

## Key Pages & Routes

- `/` - Home page (different for authenticated/unauthenticated users)
- `/login` - Authentication (login/signup + Google OAuth)
- `/login/callback` - OAuth callback handler (server route)
- `/ingredientes` - CRUD for ingredients with multi-select type filter
- `/planes` - Weekly plan generation, editing, and saved plans list
- `/familia` - Family management (create, join, view members)

**Deprecated pages:** `/combinaciones`, `/alimentos`, `/platos` (legacy architecture removed)

## Project Structure

```
/src
  /app                    # Next.js App Router pages
    /api
      /planning
        /generate         # AI planning with SSE streaming
          route.ts        # POST handler for plan generation
    /ingredientes         # Ingredient CRUD
    /planes               # Weekly planning with AI rules
    /familia              # Family management
    /login                # Authentication
    /reglas               # Rules CRUD (AI-powered)
  /components             # Reusable components
    Toast.tsx             # Toast notifications
    ConfirmDialog.tsx     # Confirmation dialogs
    PlanningProgressModal.tsx  # SSE progress modal with animated SVG
  /lib
    /supabase             # Supabase client (browser + server)
    /agents               # AI agent system (LangGraph-inspired)
      planning-agent.ts   # Main orchestrator
      /nodes              # Specialized agent nodes
        generate-base-plan.ts
        validate-rules.ts
        suggest-modifications.ts
        apply-modifications.ts
        finalize.ts
      state.ts            # Agent state management
    /llm                  # LLM integration
      gemini-client.ts    # Gemini API client
    meal-patterns.ts      # Pattern validation logic
    weekly-planner.ts     # Main planning engine
  /types                  # TypeScript definitions
    index.ts              # Core types (FoodIngredient, etc.)
    family.ts             # Family-related types
    agent.ts              # Agent types (SSEEvent, ConflictDetail, etc.)
/supabase/migrations      # Database migrations
/tests
  /component              # Vitest component tests
  /e2e                    # Playwright E2E tests
  /utils                  # Test utilities (mocks, helpers)
  .env.test               # Test environment config
/docs                     # Documentation
  BACKLOG.md              # Roadmap and pending tasks
  IMPLEMENTATION-SUMMARY.md  # Technical implementation details
```

## Database Migrations

Migrations are in `/supabase/migrations/` with numeric prefixes (e.g., `000_initial_schema.sql`).

**Important migrations:**
- `000_initial_schema.sql` - Core tables and RLS policies (base schema)
- `011_family_system.sql` - Family tables and RPC functions
- `019_comprehensive_rls_fix.sql` - Comprehensive RLS fixes
- `020_verify_and_fix_rls.sql` - RLS verification and fixes for weekly_plans
- `021_create_rules_table.sql` - AI-powered rules table
- `022_add_family_id_to_rules.sql` - Family sharing for rules
- `023_create_agent_logs.sql` - LangGraph agent execution logs

**RLS Pattern:** All policies use `get_current_user_family_id()` function to avoid infinite recursion issues.

## Environment Variables

The project uses **3 separate environments**, each with its own Supabase project:

| Environment | File | Supabase Project | Purpose |
|-------------|------|------------------|---------|
| Development | `.env.local` | vxhjzhwlyuiinpelpqae | Local dev, safe for experimentation |
| Testing | `tests/.env.test` | xgofutvrhfpywqhrrvlp | Automated tests (Vitest + Playwright) |
| Production | Vercel env vars | ovhzvwmiouaoilswgeef | Deployed app |

### Development Environment (.env.local)

```env
# Supabase Dev Project
NEXT_PUBLIC_SUPABASE_URL=https://vxhjzhwlyuiinpelpqae.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_dev_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_dev_service_role_key

# Gemini AI (for rules validation)
GOOGLE_API_KEY=your_gemini_api_key

# Model configuration (optional, defaults to gemini-2.5-flash)
GEMINI_MODEL=gemini-2.5-flash
```

### Testing Environment (tests/.env.test)

```env
# Supabase Test Project
NEXT_PUBLIC_SUPABASE_URL=https://xgofutvrhfpywqhrrvlp.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_test_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_test_service_role_key
GOOGLE_API_KEY=your_gemini_api_key
```

### Production Environment (Vercel)

Configured in Vercel Dashboard → Project Settings → Environment Variables:
- `NEXT_PUBLIC_SUPABASE_URL` → https://ovhzvwmiouaoilswgeef.supabase.co
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` → prod_anon_key
- `SUPABASE_SERVICE_ROLE_KEY` → prod_service_role_key
- `GOOGLE_API_KEY` → your_gemini_api_key

**Gemini Model Options:**
- `gemini-2.5-flash` - Latest free tier (recommended for dev/test)
- `gemini-2.0-flash-exp` - Experimental with better reasoning (for production)
- `gemini-flash-latest` - Alias for latest stable flash model

**See [docs/AMBIENTES.md](docs/AMBIENTES.md) for complete environment configuration guide.**

## Important Patterns & Conventions

### Type System

- Ingredient types are stored as strings (not enum) for flexibility
- Meal types: 'Desayuno', 'Almuerzo', 'Onces'
- Pattern ingredient requirements defined in `meal_patterns.ingredient_types` (JSONB)

### Data Isolation

- All user data is isolated by `family_id` through RLS
- Users can only see data from families they belong to
- Family membership checked via `family_members` table

### Component Tests

Use Vitest with React Testing Library. Example pattern:
```typescript
import { render, screen } from '@testing-library/react'
import { expect, test } from 'vitest'
```

### E2E Tests

Playwright tests in `tests/e2e/`. Use separate contexts for multi-user scenarios:
```typescript
const context1 = await browser.newContext()
const page1 = await context1.newPage()
// Each context = isolated session
```

## Known Issues & Gotchas

1. **Motor de Reglas:** Rule engine exists but rules are not fully applied by the algorithm. Needs validation improvement.

2. **Mobile UX Issues:**
   - Typography colors too light on mobile
   - Horizontal menu hidden in vertical orientation
   - Excessive scrolling required

3. **Security - Plan Visibility:** Non-family members can see saved plans from other families. RLS policies on `weekly_plans` need review.

4. **Home Page Hardcoded Stats:** Summary numbers (96 Alimentos, etc.) are hardcoded and shown to unauthenticated users.

## Testing Strategy

- Component tests: UI components in isolation
- E2E tests: Full user flows (auth, data isolation, family sharing)
- Test users created programmatically via `tests/scripts/create-test-users.ts`
- Coverage target: 70% (statements, branches, functions, lines)

## Session Workflow

### Starting a Session

**Quick Start Prompt:**
```
Nueva sesión - lee docs/BACKLOG.md y preséntame:
1. Estado actual (qué funciona)
2. Top 3 prioridades
3. Opciones de trabajo

Espera mi decisión antes de comenzar.
```

**What Claude will do:**
1. Read [docs/BACKLOG.md](docs/BACKLOG.md) for current priorities
2. Read [docs/IMPLEMENTATION-SUMMARY.md](docs/IMPLEMENTATION-SUMMARY.md) for technical context
3. Present executive summary with actionable options
4. Wait for user decision before starting work
5. Use TodoWrite tool to track progress during session

### During the Session

- Claude automatically uses `TodoWrite` to track tasks in progress
- You focus on decisions, not task management
- Ask questions anytime to clarify requirements or approaches

### Ending a Session

**Quick Close Prompt:**
```
Cierra sesión: actualiza docs (BACKLOG.md, IMPLEMENTATION-SUMMARY.md)
con lo completado hoy, verifica consistencia, y sugiere commit si aplica.
```

**What Claude will do:**
1. Summarize work completed (files changed, features implemented)
2. Update [docs/BACKLOG.md](docs/BACKLOG.md):
   - Mark completed tasks with [x]
   - Add new tasks discovered
   - Update "Última actualización" date
3. Update [docs/IMPLEMENTATION-SUMMARY.md](docs/IMPLEMENTATION-SUMMARY.md):
   - Add new features to "Código Implementado"
   - Update "Notas Importantes" with tech debt
   - Update date
4. Verify documentation consistency
5. Suggest commit message if changes were made

**When NOT to commit:**
- Code has errors or doesn't work
- Tests are failing
- Work is incomplete or half-done

**When to commit:**
- Feature is complete and functional
- Tests passing
- Documentation updated

### Automation with Hooks

You can automate session start/end with Claude Code hooks. See [docs/PROMPT-INICIO-SESION.md](docs/PROMPT-INICIO-SESION.md) and [docs/PROMPT-CIERRE-SESION.md](docs/PROMPT-CIERRE-SESION.md) for details.

To configure hooks interactively:
```bash
/hooks
```

## Documentation

- [README.md](README.md) - Quick start guide (in Spanish)
- [docs/BACKLOG.md](docs/BACKLOG.md) - Full roadmap, completed features, pending tasks
- [docs/IMPLEMENTATION-SUMMARY.md](docs/IMPLEMENTATION-SUMMARY.md) - Technical implementation details
- [docs/AMBIENTES.md](docs/AMBIENTES.md) - Environment configuration (dev, test, prod)
- [docs/MEAL-PATTERNS-FINAL.md](docs/MEAL-PATTERNS-FINAL.md) - Meal pattern system documentation
- [docs/SETUP-AUTH.md](docs/SETUP-AUTH.md) - Authentication setup guide
- [docs/PROMPT-INICIO-SESION.md](docs/PROMPT-INICIO-SESION.md) - Session start prompt (detailed reference)
- [docs/PROMPT-CIERRE-SESION.md](docs/PROMPT-CIERRE-SESION.md) - Session close prompt (detailed reference)

Deprecated architecture docs moved to `docs/obsolete/`.
